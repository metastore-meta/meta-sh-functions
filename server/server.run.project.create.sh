#!/usr/bin/env bash

# -------------------------------------------------------------------------------------------------------------------- #
# Server. Create project.
# -------------------------------------------------------------------------------------------------------------------- #
# @author Kitsune Solar <https://kitsune.solar>
# @version 1.0.0
# -------------------------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Settings.
# -------------------------------------------------------------------------------------------------------------------- #

# User prefix.
user_prefix="web_"

# User info.
username=""
domain=""
owner=""

# Sleep.
sleep="1"

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Phrases.
# -------------------------------------------------------------------------------------------------------------------- #

phrase_01="\n[ Новый пользователь ]\n"
phrase_02="\tИмя пользователя (${user_prefix}): "
phrase_04="\tИмя домена: "
phrase_05="\nСоздание структуры директорий...\n"
phrase_06="\nСоздание скрипта запуска cgi-php...\n"
phrase_07="\nСоздание VirtualHost...\n"
phrase_08="\nОбновление прав пользователя...\n"
phrase_09="\nЗапись информации о проекте...\n"
phrase_10="\tВладелец (ФИО): "
phrase_results_01="\n[ Результаты ]\n"
phrase_results_02="\tИмя домена:                   "
phrase_results_03="\tИмя пользователя:             "
phrase_done="\n...Завершено!\n"

# -------------------------------------------------------------------------------------------------------------------- #
# -----------------------------------------------------< SCRIPT >----------------------------------------------------- #
# -------------------------------------------------------------------------------------------------------------------- #

printf "${phrase_01}"

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Add user.
# -------------------------------------------------------------------------------------------------------------------- #

# Read variables.
printf "${phrase_02}"
read username
printf "${phrase_04}"
read domain
printf "${phrase_10}"
read owner

user="${user_prefix}${username}"

useradd -b /home/projects -m -s /bin/zsh ${user} && passwd ${user}
printf "${phrase_done}"
sleep ${sleep}

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Directories.
# -------------------------------------------------------------------------------------------------------------------- #

printf "${phrase_05}"

mkdir -p /home/projects/${user}/{.auth,.logs,.temp}
mkdir -p /home/projects/${user}/.temp/php/{opcache,session,upload,wsdlcache}
mkdir -p /home/projects/${user}/domain/public_html
mkdir -p /home/projects/${user}/subdomain

printf "${phrase_done}"
sleep ${sleep}

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Project info.
# -------------------------------------------------------------------------------------------------------------------- #

printf "${phrase_09}"

cat > /home/projects/${user}/INFO.PROJECT.txt <<EOF
# -------------------------------------------------------------------------------------------------------------------- #
# Project Information
# -------------------------------------------------------------------------------------------------------------------- #

User:               ${user}
Domain:             ${domain}
Owner:              ${owner}
EOF

printf "${phrase_done}"
sleep ${sleep}

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Apache & Nginx virtual host.
# -------------------------------------------------------------------------------------------------------------------- #

printf "${phrase_07}"

cat > /etc/httpd/vhosts.d/${domain}.ssl.conf <<EOF
# -------------------------------------------------------------------------------------------------------------------- #
# VirtualHost: ${domain}
# -------------------------------------------------------------------------------------------------------------------- #
# @author Kitsune Solar
# @version 1.0.0-SSL
# @package httpd
# -------------------------------------------------------------------------------------------------------------------- #

<VirtualHost 127.0.0.1:8081>

	# ---------------------------------------------------------------------------------------------------------------- #
	# Meta.
	# ---------------------------------------------------------------------------------------------------------------- #

	AssignUserID    ${user} ${user}
	ServerAdmin     webmaster@localhost
	DocumentRoot    "/home/projects/${user}/domain/public_html/"
	ServerName      ${domain}
	ServerAlias     www.${domain}

	# ---------------------------------------------------------------------------------------------------------------- #
	# Directory.
	# ---------------------------------------------------------------------------------------------------------------- #

	<Directory "/home/projects/${user}/domain/public_html/">
		Options -Indexes +FollowSymLinks
		AllowOverride All
		Require all granted
	</Directory>

	# ---------------------------------------------------------------------------------------------------------------- #
	# PHP.
	# ---------------------------------------------------------------------------------------------------------------- #

	php_value session.save_path "/home/projects/${user}/.temp/php/session"

	# ---------------------------------------------------------------------------------------------------------------- #
	# SSL.
	# ---------------------------------------------------------------------------------------------------------------- #

	SSLEngine               on
	SSLCertificateFile      "/home/apps/app_certbot/.acme/certs/${domain}/cert.pem"
	SSLCertificateKeyFile   "/home/apps/app_certbot/.acme/certs/${domain}/privkey.pem"
	SSLCertificateChainFile "/home/apps/app_certbot/.acme/certs/${domain}/chain.pem"

	# ---------------------------------------------------------------------------------------------------------------- #
	# Log.
	# ---------------------------------------------------------------------------------------------------------------- #

	ErrorLog    /home/projects/${user}/.logs/error.${domain}.log
	CustomLog   /dev/null common

</VirtualHost>
EOF

cat > /etc/nginx/vhosts.d/${domain}.ssl.proxy.conf <<EOF
# -------------------------------------------------------------------------------------------------------------------- #
# VirtualHost: ${domain}
# -------------------------------------------------------------------------------------------------------------------- #
# @author Kitsune Solar
# @version 1.0.0-SSL
# @package nginx
# -------------------------------------------------------------------------------------------------------------------- #

server {

	# ---------------------------------------------------------------------------------------------------------------- #
	# Server name & IP.
	# ---------------------------------------------------------------------------------------------------------------- #

	listen       443 ssl http2;
	server_name  ${domain};

	# ---------------------------------------------------------------------------------------------------------------- #
	# Logs.
	# ---------------------------------------------------------------------------------------------------------------- #

	access_log off;

	# ---------------------------------------------------------------------------------------------------------------- #
	# SSL.
	# ---------------------------------------------------------------------------------------------------------------- #

	ssl                     on;
	ssl_certificate         "/home/apps/app_certbot/.acme/certs/${domain}/fullchain.pem";
	ssl_certificate_key     "/home/apps/app_certbot/.acme/certs/${domain}/privkey.pem";
	ssl_trusted_certificate "/home/apps/app_certbot/.acme/certs/${domain}/chain.pem";

	# ---------------------------------------------------------------------------------------------------------------- #
	# Location.
	# ---------------------------------------------------------------------------------------------------------------- #

	location / {
		proxy_pass https://127.0.0.1:8081/;
		include /etc/nginx/default.d/proxy.server.location.inc.conf;
	}

	location /.well-known/acme-challenge {
		alias /home/apps/app_certbot/.acme/challenges;
	}

	# ---------------------------------------------------------------------------------------------------------------- #
	# Include proxy-server configuration.
	# ---------------------------------------------------------------------------------------------------------------- #

	include /etc/nginx/default.d/proxy.server.inc.conf;

}

# -------------------------------------------------------------------------------------------------------------------- #
# VirtualHost: www.${domain}
# -------------------------------------------------------------------------------------------------------------------- #
# @author Kitsune Solar
# @version 1.0.0-SSL
# @package nginx
# -------------------------------------------------------------------------------------------------------------------- #

server {

	# ---------------------------------------------------------------------------------------------------------------- #
	# Server name & IP.
	# ---------------------------------------------------------------------------------------------------------------- #

	listen       443 ssl http2;
	server_name  www.${domain};

	# ---------------------------------------------------------------------------------------------------------------- #
	# Logs.
	# ---------------------------------------------------------------------------------------------------------------- #

	access_log off;

	# ---------------------------------------------------------------------------------------------------------------- #
	# SSL.
	# ---------------------------------------------------------------------------------------------------------------- #

	ssl                     on;
	ssl_certificate         "/home/apps/app_certbot/.acme/certs/${domain}/fullchain.pem";
	ssl_certificate_key     "/home/apps/app_certbot/.acme/certs/${domain}/privkey.pem";
	ssl_trusted_certificate "/home/apps/app_certbot/.acme/certs/${domain}/chain.pem";

	# ---------------------------------------------------------------------------------------------------------------- #
	# Redirect.
	# ---------------------------------------------------------------------------------------------------------------- #

	return 301 \$scheme://${domain}\$request_uri;
}
EOF

printf "${phrase_done}"
sleep ${sleep}

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Permissions.
# -------------------------------------------------------------------------------------------------------------------- #

printf "${phrase_08}"

chown -R ${user}:${user} /home/projects/${user}/

printf "${phrase_done}"
sleep ${sleep}

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Results.
# -------------------------------------------------------------------------------------------------------------------- #

printf "${phrase_results_01}"
printf "${phrase_results_02} ${domain}\n"
printf "${phrase_results_03} ${user}\n"

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Exit.
# -------------------------------------------------------------------------------------------------------------------- #

exit 0
