#!/usr/bin/env bash

# -------------------------------------------------------------------------------------------------------------------- #
# Database Backup Script
# -------------------------------------------------------------------------------------------------------------------- #
# @author Kitsune Solar <https://kitsune.solar>
# @version 1.0.0
# -------------------------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Settings.
# -------------------------------------------------------------------------------------------------------------------- #

source "${HOME}/.apps/server.run.project.db.backup.config.sh"

# -------------------------------------------------------------------------------------------------------------------- #
# -----------------------------------------------------< SCRIPT >----------------------------------------------------- #
# -------------------------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Backup databases.
# -------------------------------------------------------------------------------------------------------------------- #

function ext.run.backup.database() {
	# Create backup directories.
	mkdir -p "${path}/${timestamp}" && cd "${path}/${timestamp}/"

	# Backup databases.
	for database in ${databases[@]}; do
		echo ""
		echo "--- Backup database: ${database}..."

		# Backup database.
		mysqldump -u "${db_user}" -p"${db_password}" -h"127.0.0.1" --opt ${database} > "${database}.${timestamp}.sql"

		# Archiving database.
		if [[ -f "${database}.${timestamp}.sql" ]]; then
			tar -cJf "${database}.${timestamp}.sql.tar.xz" "${database}.${timestamp}.sql"
		fi

		# Print "done" phrase.
		echo "--- Backup database: ${database} - complete!"
		echo ""

		# Sleep.
		sleep ${sleep}
	done

	# Remove *.sql.
	rm -f *.sql

	# Email report.
	echo "$( ls -1hs )" | mailx -s "SRV-01: Backup Database" "${mail_to}"
}

ext.run.backup.database

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Exit.
# -------------------------------------------------------------------------------------------------------------------- #

exit 0
