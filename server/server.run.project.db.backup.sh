#!/usr/bin/env bash

# -------------------------------------------------------------------------------------------------------------------- #
# Database Backup Script
# -------------------------------------------------------------------------------------------------------------------- #
# @author Kitsune Solar <https://kitsune.solar>
# @version 1.0.0
# -------------------------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Settings.
# -------------------------------------------------------------------------------------------------------------------- #

source "${HOME}/.apps/server.run.project.db.backup.config.sh"

# -------------------------------------------------------------------------------------------------------------------- #
# -----------------------------------------------------< SCRIPT >----------------------------------------------------- #
# -------------------------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Create backup directories.
# -------------------------------------------------------------------------------------------------------------------- #

mkdir -p "${path}/${timestamp}" && cd "${path}/${timestamp}/"

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Backup databases.
# -------------------------------------------------------------------------------------------------------------------- #

for database in ${databases[@]}; do
	echo ""
	echo "--- Backup database: ${database}..."

	# Backup database.
	mysqldump -u "${db_user}" -p"${db_password}" -h"127.0.0.1" --opt ${database} > "${database}.${timestamp}.sql"

	# Archiving database.
	if [[ -f "${database}.${timestamp}.sql" ]]; then
		tar -cJf "${database}.${timestamp}.sql.tar.xz" "${database}.${timestamp}.sql"
	fi

	# Print "done" phrase.
	echo "--- Backup database: ${database} - complete!"
	echo ""

	# Sleep.
	sleep ${sleep}
done

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Remove *.sql.
# -------------------------------------------------------------------------------------------------------------------- #

rm -f *.sql

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Email report.
# -------------------------------------------------------------------------------------------------------------------- #

echo "$( ls -1hs )" | mailx -s "SRV-01: Backup Database" "${mail_to}"

# -------------------------------------------------------------------------------------------------------------------- #
# Script: Exit.
# -------------------------------------------------------------------------------------------------------------------- #

exit 0
